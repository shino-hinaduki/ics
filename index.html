<!DOCTYPE html>
<html>
  <head>
    <title>OpenCV.js Demo: Image Channels Separation</title>
    <meta charset="utf-8" />
    <script
      async
      src="https://docs.opencv.org/master/opencv.js"
      onload="onOpenCvReady();"
      type="text/javascript"
    ></script>
    <style>
      .canvas_container {
        margin-top: 10px;
        display: inline-block;
      }
    </style>
  </head>
  <body>
    <h2>Image Channels Separation</h2>
    <p>
      Drag and drop an image file onto the page or select a file using the input
      field to display the separated channels.
    </p>
    <div>
      <input type="file" id="file_input" />
      <button id="download-button">Download All Images</button>
    </div>
    <div id="input_canvas_container" class="canvas_container">
      <canvas id="input_canvas"></canvas>
    </div>
    <div id="canvas_container">
      <canvas id="canvas_0" class="channel_canvas"></canvas>
      <canvas id="canvas_1" class="channel_canvas"></canvas>
      <canvas id="canvas_2" class="channel_canvas"></canvas>
      <canvas id="canvas_3" class="channel_canvas"></canvas>
    </div>
    <script type="text/javascript">
      let imgElement = document.createElement("img");
      let downloadButton = document.getElementById("download-button");
      let inputCanvas = document.getElementById("input_canvas");
      let inputCtx = inputCanvas.getContext("2d");
      let channelCanvases = [];
      let filenameWithoutExt = "filenameWithoutExt";

      function onOpenCvReady() {
        // Enable drag and drop
        document.ondragover = document.ondrop = (event) => {
          event.preventDefault();
        };

        // Load the image when a file is dropped
        inputCanvas.ondrop = (event) => {
          event.preventDefault();
          filenameWithoutExt = event.dataTransfer.files[0].name;
          imgElement.src = URL.createObjectURL(event.dataTransfer.files[0]);
        };

        // Load the image when a file is selected
        document.getElementById("file_input").onchange = (event) => {
          filenameWithoutExt = event.target.files[0].name;
          imgElement.src = URL.createObjectURL(event.target.files[0]);
        };

        imgElement.onload = () => {
          // Draw the input image on the canvas
          inputCanvas.width = imgElement.width;
          inputCanvas.height = imgElement.height;
          inputCtx.drawImage(imgElement, 0, 0);

          // Convert the canvas to a Mat
          let mat = cv.imread(inputCanvas);

          // Split the channels
          let channels = new cv.MatVector();
          cv.split(mat, channels);

          // Create a canvas for each channel and display the separated channels
          for (let i = 0; i < channels.size(); i++) {
            let channelCanvas = document.getElementById("canvas_" + i);
            let channelCtx = channelCanvas.getContext("2d");
            channelCanvas.width = mat.cols;
            channelCanvas.height = mat.rows;
            cv.imshow(channelCanvas.id, channels.get(i));
            channelCanvases.push(channelCanvas);
          }

          // チャンネルごとにダウンロードするボタンを作成する
          for (let c = 0; c < 4; c++) {
            const canvas = document.getElementById(`canvas_${c}`);
            const a = document.createElement("a");
            a.download = `${filenameWithoutExt}_${c}.png`;
            a.href = canvas.toDataURL("image/png");
            a.textContent = `Download Channel ${c + 1}`;
            document.body.appendChild(a);
          }

          // Free memory
          mat.delete();
          channels.delete();
        };
      }
    </script>
  </body>
</html>
